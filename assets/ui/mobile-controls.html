<!-- ========================================
  HYTOPIA SDK-COMPLIANT MOBILE CONTROLS
  Ark Rush - Animal Collection Game

  Based on HYTOPIA_MOBILE_CONTROLS_GUIDE.md
======================================== -->

<div class="mobile-controls" id="mobile-controls">
  <div class="mobile-left-controls">
    <button id="mobile-sprint-btn" class="mobile-btn sprint-btn" aria-label="Run">
      <span class="btn-icon">&#x1F3C3;</span>
      <span class="btn-label">RUN</span>
    </button>
  </div>

  <div class="mobile-right-controls">
    <div class="mobile-btn-row">
      <button id="mobile-jump-btn" class="mobile-btn jump-btn" aria-label="Jump">
        <span class="btn-icon">&#x2B06;</span>
        <span class="btn-label">JUMP</span>
      </button>
      <button id="mobile-interact-btn" class="mobile-btn interact-btn primary-action" aria-label="Interact">
        <span class="btn-icon">&#x1F43E;</span>
        <span class="btn-label">GRAB</span>
      </button>
    </div>
  </div>
</div>

<style>
  .mobile-controls { display: none; }

  body.mobile .mobile-controls,
  body.mobile.gameplay-active .mobile-controls {
    display: block;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 2000;
  }

  body.mobile .mobile-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 70px; height: 70px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.65);
    border: 3px solid rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(8px);
    color: white;
    pointer-events: auto;
    touch-action: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    transition: transform 0.1s ease;
  }

  body.mobile .mobile-btn:active,
  body.mobile .mobile-btn.active {
    transform: scale(0.88);
    background: rgba(0, 0, 0, 0.85);
  }

  body.mobile .btn-icon { font-size: 24px; margin-bottom: 2px; }
  body.mobile .btn-label { font-size: 10px; font-weight: 700; }

  body.mobile .mobile-left-controls { position: fixed; left: 25px; bottom: 130px; }
  body.mobile .mobile-right-controls { position: fixed; right: 20px; bottom: 50px; }
  body.mobile .mobile-btn-row { display: flex; gap: 15px; }
  body.mobile .mobile-btn.primary-action { width: 85px; height: 85px; }
  body.mobile .primary-action .btn-icon { font-size: 32px; }

  /* Interact/Grab - Brown wooden ark theme */
  body.mobile .interact-btn {
    background: linear-gradient(145deg, rgba(139, 90, 43, 0.9), rgba(101, 67, 33, 0.95));
    border-color: rgba(210, 150, 90, 0.7);
  }
  body.mobile .interact-btn.active { box-shadow: 0 0 25px rgba(210, 150, 90, 0.6); }

  /* Jump - Blue sky theme */
  body.mobile .jump-btn {
    background: linear-gradient(145deg, rgba(100, 180, 255, 0.85), rgba(60, 140, 220, 0.9));
    border-color: rgba(150, 210, 255, 0.6);
  }

  /* Sprint - Green nature theme */
  body.mobile .sprint-btn {
    background: linear-gradient(145deg, rgba(80, 180, 80, 0.85), rgba(50, 140, 50, 0.9));
    border-color: rgba(120, 220, 120, 0.6);
  }
</style>

<script>
(function() {
  'use strict';
  const isMobile = document.body.classList.contains('mobile') || (window.hytopia && window.hytopia.isMobile);
  if (!isMobile) return;

  const BUTTONS = {
    'mobile-interact-btn': { input: 'e',  behavior: 'tap',  name: 'Interact' },
    'mobile-jump-btn':     { input: 'sp', behavior: 'tap',  name: 'Jump' },
    'mobile-sprint-btn':   { input: 'sh', behavior: 'hold', name: 'Sprint' }
  };

  function setupButton(id, cfg) {
    const btn = document.getElementById(id);
    if (!btn) return;
    let pressed = false, touchId = null;

    function press(tid) {
      if (pressed) return;
      pressed = true; touchId = tid;
      btn.classList.add('active');
      if (window.hytopia?.pressInput) window.hytopia.pressInput(cfg.input, true);
      if (cfg.behavior === 'tap') setTimeout(() => release(tid), 150);
    }

    function release(tid) {
      if (!pressed || (tid !== undefined && tid !== touchId)) return;
      pressed = false; touchId = null;
      btn.classList.remove('active');
      if (window.hytopia?.pressInput) window.hytopia.pressInput(cfg.input, false);
    }

    btn.addEventListener('touchstart', e => { e.preventDefault(); press(e.changedTouches[0].identifier); }, { passive: false });
    btn.addEventListener('touchend', e => { e.preventDefault(); for (const t of e.changedTouches) if (t.identifier === touchId) release(t.identifier); }, { passive: false });
    btn.addEventListener('touchcancel', e => { for (const t of e.changedTouches) if (t.identifier === touchId) release(t.identifier); }, { passive: false });
    btn.addEventListener('mousedown', e => { e.preventDefault(); press(-1); });
    btn.addEventListener('mouseup', () => release(-1));
    btn.addEventListener('mouseleave', () => { if (pressed) release(-1); });
    btn.addEventListener('contextmenu', e => e.preventDefault());
  }

  setTimeout(() => { for (const [id, cfg] of Object.entries(BUTTONS)) setupButton(id, cfg); }, 100);
})();
</script>
